#include <stddef.h>
#include <stdio.h>
#include <sys/types.h>
#include <keyutils.h>

/*
If, after the program has run, there something like the following line in /proc/keys:
    
    3f3d898f I--Q---   100 perm 3f3f0000     0     0 keyring   leaked-keyring: empty
    
with a usage count of 100 * the number of times the program has been run,
then the kernel is malfunctioning.  If leaked-keyring has zero usages or
has been garbage collected, then the problem is fixed.
*/

int main(int argc, const char *argv[])
{
  key_serial_t serial = keyctl(KEYCTL_JOIN_SESSION_KEYRING,
                             "leaked-keyring");
  if (serial < 0) {
    perror("keyctl");
    return -1;
  }

  if (keyctl(KEYCTL_SETPERM, serial,
             KEY_POS_ALL | KEY_USR_ALL) < 0) {
    perror("keyctl");
    return -1;
  }

  for (int i = 0; i < 100; i++) {
    serial = keyctl(KEYCTL_JOIN_SESSION_KEYRING,
                    "leaked-keyring");
    if (serial < 0) {
      perror("keyctl");
      return -1;
    }
  }

  return 0;
}
